define(["players"],function(e){var s=App.Request,c=App.Path.Func,n=new App.NodeCache({native:!0});n.setContext("#komentarze"),n.cache({normal:["#mce_main","#reply"],jquery:[".nano","#comments-list"],extend:[".toggleEditor",".comments",".comment-mode"]});var l={LoadTemplate:function(e,i){return document.getElementById(e).innerHTML.replace(/{(\w*)}/g,function(e,t){return i.hasOwnProperty(t)?i[t]:""})},init:function(){require(["fbsdk"]),this.GifPlayer.init(),App.EventHandler.register("click",[{css:".show-embed",fn:function(){$(".post-share-code").toggle()}},{css:".c-sort",fn:this.SortComments},{css:".reply-comment",fn:this.Reply},{css:".cm_vote",fn:this.Vote},{css:".load-replies",fn:this.LoadReplies},{css:".load-comments",fn:this.LoadComments},{css:".remove",fn:this.Remove},{css:".comment-mode",fn:this.SetView},{css:".edit",fn:t.initMCE.bind(t,"edit")},{css:".js-click-select",fn:function(){this.select()}},{css:".toggleEditor",fn:t.initMCE.bind(t,"toggle")}])},LoadReplies:function(t){t.target.innerHTML='<i class="rotate icon-spinner4"></i>';var e={id:t.target.dataset.id,mode:"show_replies"};s("post",c,e).then(function(e){t.target.outerHTML=e,$(".tip").getTip()})},SortComments:function(e){e.preventDefault();var t=e.target,i=t.parentElement,n=document.getElementById("comments-list"),a={mode:"sort_comments",sort:this.dataset.sort,id:i.dataset.id};n.innerHTML='<div class="loading-comments"><i class="icon-spinner4 rotate"></i></div>',i.querySelectorAll(".c-sort").forEach(function(e){e.classList.remove("active")}),t.classList.add("active"),s("post",c,a).then(function(e){n.innerHTML=e,$(".tip").getTip()})},LoadComments:function(t){t.target.innerHTML='<i class="rotate icon-spinner4"></i>';var e=t.target.dataset,i={id:e.id,start:e.start,mode:"show_comments",sort:e.sort};s("post",c,i).then(function(e){t.target.outerHTML=e,$(".tip").getTip()})},Vote:function(e){var t=e.target;e.preventDefault();var i=t.closest(".combox"),n={mode:"comvote",vote:t.dataset.vote,commid:i.dataset.commid};s("post",c,n).then(function(e){var t=JSON.parse(e);i.querySelector(".upvotes").innerHTML=t.vote_up,i.querySelector(".downvotes").innerHTML=t.vote_down})},GifPlayer:{items:[],init:function(){var e=App.Query(".gif-player",null,!0);e&&(this.items=e,this.preload())},createLoader:function(){return function(e,t){for(var i in t){var n=App.Create("div",{className:t[i]});e.appendChild(n)}return e}(App.Create("div",{className:"icon-gif"}),["_393-","ring","_30h"])},preload:function(){for(var e in this.items){var t,i=this.items[e],n=i.parentElement,a=this.createLoader();n.appendChild(a),(t=n.querySelector(".img-overlay"))&&(t.style.display="none"),function(a,r){var o,s,t=function(){if(s)return"playing"==s?(r.classList.remove("playing"),a.src=a.src.replace(".gif",".jpg"),void(s="paused")):(r.classList.add("playing"),a.src=a.src.replace(".jpg",".gif"),void(s="playing"));var e=a.dataset.src.replace(".jpg",".gif"),t=r.querySelector(".ring"),i=App.Create("img",{src:e});t.classList.add("rotate2");var n=function(){a.src=e,s="playing",a.dataset.src=e,r.classList.add("playing"),t.classList.remove("rotate2")};i.complete&&0<i.naturalWidth?n():App.Create("img",{onerror:n,src:e,onload:n}),o.disconnect()};(o=new MutationObserver(function(e){a.addEventListener("click",t)})).observe(a,{attributes:!0,attributeFilter:["class"],childList:!1,characterData:!1})}(i,a)}}},AddTip:function(e,t){e.dataset.tooltip={pos:"bottom"},e.title=t,$(e).getTip()},Reply:function(e){var t=e.target;e.preventDefault();var i=t.dataset,n=App.ById("comments-list");if(i.open){var a=App.ById("r-form-"+i.repid);(function(e){delete e.open,this.parentElement.removeChild(this)}).call(a,i)}else{i.open=!0;var r=l.LoadTemplate("reply_template",{id:i.repid,postid:n.dataset.postid,parent_user:i.repuser}),o=App.html2dom(r);(a=o.querySelector("form")).onsubmit=function(t,i,e){e.preventDefault();var n=this,a=App.ParseForm.call(this);a.Data.mode="addrpl",s("post",c,a.Data).then(function(e){e=JSON.parse(e),delete i.open,n.parentElement.removeChild(n),$(t.closest(".combox")).after(e.html),$(".tip").getTip()})}.bind(a,t,i),t.closest(".comment-box").appendChild(o)}},SetView:function(e){var t=e.target;e.preventDefault(),n.Comments.hide(),n.CommentMode.removeClass("selected"),t.classList.add("selected");var i=t.dataset.mode;n.get(".com-"+i+":jquery").removeClass("hide-forced"),n.get(".com-"+i+":jquery").removeClass("hide").fadeIn(500),"page"==i&&n.CommentsList.trigger("resize")},Remove:function(e){var t=e.target;e.preventDefault();var i=t.closest(".combox"),n={mode:"delcmt",postid:i.dataset.postid,commid:i.dataset.commid,replid:t.dataset.replid};App.Modal("confirm",Lang.get("please_confirm"),Lang.get("comm_will_be_removed"),function(e){e&&s("post",c,n).then(function(e){1==e&&$(i).slideUp(500)})})}},t={initMCE:function(a,r){require(["tinycfg","tinyMCE"],function(e){switch(a){case"edit":var t=r.target.closest(".combox"),i=t.dataset.commid,n=tinymce.EditorManager.get("cm_"+i);if(n){t.querySelectorAll(".yt-player");return n.editorManager.execCommand("mceToggleEditor",!1,n.id)}e.inline.selector="#cm_"+i,tinymce.init(e.inline).then(self.Edit);case"toggle":if(this.mainReady)return this.Toggle(r);this.mainReady=!0,tinyMCE.init(e.lite)}}.bind(this))},Toggle:function(){tinyMCE.EditorManager.execCommand("mceToggleEditor",!0,"mce_main")},Edit:function(e){var t=e.target.closest(".combox").dataset.commid;return tinymce.EditorManager.get("cm_"+t).focus(),!1}},r={values:null,wrapper:null,init:function(){if(!1===App.Exist(".reactions"))return!1;this.wrapper=App.Query(".reactions"),this.values=App.Query(".value",this.wrapper),["like.gif","love.gif","sad.gif","angry.gif","lol.gif","what.gif"].forEach(function(e){App.Create("img",{src:"Template/Reactions/"+e})}),App.EventHandler.register("click",[{css:".reactions",fn:this.send}]),this.calculate()},calculate:function(){var a=0;r.values.forEach(function(e,t){var i=e.dataset.value;0<i&&(a+=+i)}),r.values.forEach(function(e,t){var i=e.dataset.value,n=100/a*+i/100;e.previousElementSibling.style.transform="scaleX("+n+")"})},update:function(e){var t=JSON.parse(e);if(t){for(var i in t){var n=App.Query("#emoji-"+i+" .value");n.innerHTML=t[i],n.dataset.value=t[i]}r.calculate()}},send:function(e){var t={mode:"reaction",vote:e.target.dataset.vote,id:r.wrapper.dataset.id};t.id&&t.vote&&s("post",c,t).then(r.update)}};e(),l.init(),r.init(),"gallery"==document.body.dataset.mode&&require(["PhotoGallery/postscript"])});